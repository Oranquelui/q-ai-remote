{
  "master": {
    "tasks": [
      {
        "id": 1,
        "title": "MVP 1-page requirements freeze",
        "description": "Document goal/non-goal/flow/prohibitions/acceptance criteria for Q CodeAnzenn MVP",
        "details": "Create docs/mvp_requirements.md with sections for product goal, in-scope/out-of-scope features, hard constraints, architecture modules, gates, and acceptance criteria. Ensure all PRD content is captured verbatim where applicable. Use Markdown formatting for clarity.",
        "testStrategy": "Run tests/docs/test_requirements_sections.py to validate all required sections exist and contain expected content. Manual review by stakeholders for approval.",
        "priority": "high",
        "dependencies": [],
        "status": "completed",
        "subtasks": []
      },
      {
        "id": 2,
        "title": "Repo tree definition",
        "description": "Define canonical repository structure for src/config/db/audit/tests/scripts",
        "details": "Create docs/repo_tree.md specifying exact directory structure matching PRD architecture modules. Include paths for all planned outputs like src/bot/, src/security/, db/schema.sql, config/policy.yaml. Generate .gitignore and basic pyproject.toml.",
        "testStrategy": "Execute tests/docs/test_repo_tree_paths.py to verify all specified paths exist and have correct structure. Check with tree command output.",
        "priority": "high",
        "dependencies": [
          1
        ],
        "status": "completed",
        "subtasks": []
      },
      {
        "id": 3,
        "title": "policy.yaml v1 configuration",
        "description": "Define commands/ops/prohibitions/allowlist/rate-limit/path rules in YAML",
        "details": "Create config/policy.yaml with schema for allowed commands (/start,/policy,/plan,/approve,/reject,/status,/logs), fixed ops (list_dir/read_file/create_file/patch_file), workspace path boundaries, rate limits, and user allowlist. Use strict YAML schema validation.",
        "testStrategy": "Run tests/config/test_policy_schema.py to validate YAML structure, required fields, and rule constraints. Test policy loading fails on invalid configs.",
        "priority": "high",
        "dependencies": [
          1
        ],
        "status": "completed",
        "subtasks": []
      },
      {
        "id": 4,
        "title": "Pydantic v2 Plan model",
        "description": "Implement Plan model that rejects absolute paths and enforces workspace-relative targets",
        "details": "In src/models/plan.py, create Pydantic BaseModel with fields for plan_id, operations[], workspace_root, risk_score. Add validators to reject absolute paths, symlinks, UNC paths. Enforce only allowed ops: list_dir/read_file/create_file/patch_file. Use pydantic>=2.0.",
        "testStrategy": "tests/models/test_plan_model.py: test valid/invalid path rejection, op validation, serialization roundtrip, workspace normalization.",
        "priority": "high",
        "dependencies": [
          3
        ],
        "status": "completed",
        "subtasks": []
      },
      {
        "id": 5,
        "title": "SecretStore interface and factory",
        "description": "Create OS-based secret provider selection with fail-closed behavior",
        "details": "Implement src/secrets/base.py (SecretStore ABC), src/secrets/factory.py (detects macOS/Windows, loads codex_api_key/telegram_token), src/config/secrets.py (config loader). Use OS credential stores only (macOS Keychain / Windows Credential Manager). Fail closed if missing credentials.",
        "testStrategy": "tests/secrets/test_factory.py: mock OS detection, test provider selection, credential retrieval without logging secrets, fail-closed on missing creds.",
        "priority": "high",
        "dependencies": [
          3
        ],
        "status": "completed",
        "subtasks": []
      },
      {
        "id": 6,
        "title": "macOS Keychain adapter",
        "description": "Implement Keychain access for codex_api_key retrieval",
        "details": "src/secrets/keychain_store.py: subclass SecretStore, use keyring.set_keyring(keyring.backends.macOS.KeychainKeyring), get_password('qcodeanzenn', 'codex_api_key'). Handle permission prompts gracefully, never log secret values.",
        "testStrategy": "tests/secrets/test_keychain_store.py: unit tests with mocked keyring, integration tests with test keychain entries, verify no secret leakage in logs.",
        "priority": "medium",
        "dependencies": [
          5
        ],
        "status": "completed",
        "subtasks": []
      },
      {
        "id": 7,
        "title": "Windows Credential Manager adapter",
        "description": "Implement Credential Manager access for codex_api_key",
        "details": "src/secrets/credman_store.py: subclass SecretStore, use keyring.backends.Windows.DesktopCredentialKeyring, get_password('qcodeanzenn', 'codex_api_key'). Explicit error messages for missing credentials.",
        "testStrategy": "tests/secrets/test_credman_store.py: mock Windows API calls, test missing credential scenarios, verify explicit error messaging.",
        "priority": "medium",
        "dependencies": [
          5
        ],
        "status": "completed",
        "subtasks": []
      },
      {
        "id": 8,
        "title": "SQLite schema for plans/audit/events",
        "description": "Create database schema supporting plan states and audit trails",
        "details": "db/schema.sql: tables for plans(plan_id, state, risk_score, short_token, created_at), audit_events(plan_id, event_type, timestamp, payload), indexes on plan_id/state/short_token. Include migrations framework with Alembic.",
        "testStrategy": "tests/db/test_schema_apply.py: test schema creation, index presence, foreign key constraints, state transition validity.",
        "priority": "high",
        "dependencies": [
          4
        ],
        "status": "completed",
        "subtasks": []
      },
      {
        "id": 9,
        "title": "Path Guard implementation",
        "description": "Block operations outside allowed paths, symlinks, junctions, UNC, absolute paths",
        "details": "src/security/path_guard.py: validate_path(path, workspace_root) checks realpath() != symlink, os.path.isabs(), UNC patterns, junction detection (Windows). Hard reject with PathGuardViolation exception. Cache resolved paths.",
        "testStrategy": "tests/security/test_path_guard.py: test symlink bypass, absolute path, UNC, junction, boundary traversal vectors.",
        "priority": "high",
        "dependencies": [
          3
        ],
        "status": "completed",
        "subtasks": []
      },
      {
        "id": 10,
        "title": "Risk engine implementation",
        "description": "Generate risk score/level/reasons; block HIGH+ risk plans",
        "details": "src/security/risk_engine.py: RiskScore.from_plan(plan) analyzes op count, write ops ratio, path depth, serial ops. Categories: LOW/MED/HIGH/CRITICAL. Return RiskReport(score, level, reasons[]). Block execution if level >= HIGH.",
        "testStrategy": "tests/security/test_risk_engine.py: test risk scoring for various op combinations, verify HIGH+ blocking logic.",
        "priority": "high",
        "dependencies": [
          4
        ],
        "status": "completed",
        "subtasks": []
      },
      {
        "id": 11,
        "title": "Plan JSON Schema exporter",
        "description": "Generate deterministic JSON schema for CI drift detection",
        "details": "scripts/export_plan_schema.py: use pydantic.json_schema() on Plan model, write to schemas/plan.schema.json with canonical sorting. Include in CI to detect model drift.",
        "testStrategy": "tests/schema/test_export_plan_schema.py: validate schema generation, roundtrip validation, canonical output consistency.",
        "priority": "medium",
        "dependencies": [
          4
        ],
        "status": "completed",
        "subtasks": []
      },
      {
        "id": 12,
        "title": "Approval service with short_token",
        "description": "Implement approval requiring plan_id + short_token with TTL",
        "details": "src/core/approval_service.py: approve(plan_id: str, short_token: str) -> bool, generate_short_token(plan_id) -> str (8-char base62, 24h TTL in SQLite), validate token/TTL mismatch rejection. Rate limit approvals per user.",
        "testStrategy": "tests/core/test_approval_service.py: test token generation/validation, TTL expiration, invalid token rejection, DB persistence.",
        "priority": "high",
        "dependencies": [
          4,
          8
        ],
        "status": "completed",
        "subtasks": []
      },
      {
        "id": 13,
        "title": "Telegram handlers for /start and /policy",
        "description": "Implement fixed-format Telegram responses for start and policy commands",
        "details": "Create src/bot/handlers_start_policy.py to serve /start and /policy. Reply with concise fixed-format policy summary only. Do not include file contents or secrets in responses.",
        "testStrategy": "tests/bot/test_start_policy.py: verify command routing, response template format, and hidden sensitive values.",
        "priority": "high",
        "dependencies": [
          3
        ],
        "status": "completed",
        "subtasks": []
      },
      {
        "id": 14,
        "title": "Planner integration and /plan handler",
        "description": "Connect Codex planner and return plan+risk without executing",
        "details": "Implement src/core/planner.py, src/adapters/codex_client.py, src/bot/handlers_plan.py. /plan must validate policy/path/risk and return plan+risk summary with short token, but must never execute ops.",
        "testStrategy": "tests/bot/test_plan_no_execute.py: confirm no side effects occur on /plan, response uses fixed concise format, and blocked plans are rejected.",
        "priority": "high",
        "dependencies": [
          6,
          7,
          8,
          9,
          10,
          11
        ],
        "status": "completed",
        "subtasks": []
      },
      {
        "id": 15,
        "title": "Approval/status Telegram handlers with allowlist and rate limits",
        "description": "Implement /approve /reject /status command flow with strict checks",
        "details": "Create src/bot/handlers_approval_status.py and src/security/rate_limit.py. Enforce allowlisted user IDs, require /approve <plan_id> <short_token>, reject malformed requests, and apply command-specific rate limits.",
        "testStrategy": "tests/bot/test_approve_reject_status.py and tests/security/test_rate_limit.py covering valid approvals, invalid token, non-allowlisted user, and limit exceeded.",
        "priority": "high",
        "dependencies": [
          12
        ],
        "status": "completed",
        "subtasks": []
      },
      {
        "id": 16,
        "title": "Safe executor and diff generation",
        "description": "Execute only fixed ops after approval and generate diff summary artifacts",
        "details": "Implement src/core/executor.py and src/core/diff_service.py. Only support list_dir/read_file/create_file/patch_file. No arbitrary command execution and no network feature in executor. Enforce path guard again at execution time.",
        "testStrategy": "tests/core/test_executor_allowed_ops.py and tests/core/test_diff_service.py validating op allowlist, second-pass path validation, and diff generation.",
        "priority": "high",
        "dependencies": [
          15,
          9
        ],
        "status": "completed",
        "subtasks": []
      },
      {
        "id": 17,
        "title": "Audit JSONL hash-chain, HTML report, and /logs handler",
        "description": "Persist tamper-evident audit records and expose them via /logs",
        "details": "Implement src/audit/audit_logger.py, src/audit/report_builder.py, and src/bot/handlers_logs.py. For each execution write JSONL events with prev_hash/event_hash chaining and produce local HTML report. /logs returns artifact paths and summary only.",
        "testStrategy": "tests/audit/test_hash_chain.py and tests/bot/test_logs_handler.py validating chain continuity, report generation, and non-disclosure of file body.",
        "priority": "high",
        "dependencies": [
          16,
          8
        ],
        "status": "completed",
        "subtasks": []
      },
      {
        "id": 18,
        "title": "Security regression suite and Telegram demo script",
        "description": "Finalize security acceptance tests and end-to-end demonstration flow",
        "details": "Create tests/security/test_regressions.py and docs/demo_script.md. Cover allowed-path bypass attempts, execution before approval, secret leakage prevention, and rate-limit enforcement. Include reproducible Telegram script steps.",
        "testStrategy": "Run tests/security/test_regressions.py::all and execute demo script manually on macOS and Windows target environments.",
        "priority": "high",
        "dependencies": [
          17
        ],
        "status": "completed",
        "subtasks": []
      },
      {
        "id": 19,
        "title": "Engine mode policy extension",
        "description": "Add codex_api/codex_subscription/claude_subscription mode config to policy",
        "details": "Extend config/policy.yaml and src/config/policy.py to support engine.mode, timeout, codex_api model, codex CLI command/model, and Claude CLI command/model. Enforce strict allowed mode validation and safe command name checks.",
        "testStrategy": "tests/config/test_policy_schema.py plus new policy loader tests for valid/invalid modes and command checks.",
        "priority": "high",
        "dependencies": [
          3
        ],
        "status": "completed",
        "subtasks": []
      },
      {
        "id": 20,
        "title": "Subscription planner adapters",
        "description": "Implement Codex CLI and Claude CLI draft plan adapters",
        "details": "Add adapters that generate structured plan JSON from codex exec and claude -p using JSON schema constraints. Use subprocess with shell=False, fixed command path from policy, timeout, and robust JSON parsing.",
        "testStrategy": "Add unit tests that mock subprocess outputs for codex/claude adapters and verify strict output parsing and failures.",
        "priority": "high",
        "dependencies": [
          19
        ],
        "status": "completed",
        "subtasks": []
      },
      {
        "id": 21,
        "title": "Runtime engine factory and secrets gate",
        "description": "Create runtime engine selection and conditional secret requirement",
        "details": "Wire runtime to choose plan engine by policy mode. Require codex_api_key only in codex_api mode; keep telegram token mandatory always. Keep existing planner/executor safety behavior unchanged.",
        "testStrategy": "Add tests for secret loading behavior by mode and runtime engine selection paths.",
        "priority": "high",
        "dependencies": [
          20,
          5
        ],
        "status": "completed",
        "subtasks": []
      },
      {
        "id": 22,
        "title": "Operator setup documentation update",
        "description": "Document setup steps for API mode and subscription mode",
        "details": "Update README with mode-by-mode setup for macOS/Windows: required credentials, required CLI login state, command examples, and failure diagnostics.",
        "testStrategy": "Manual walkthrough on clean environment using documented steps.",
        "priority": "medium",
        "dependencies": [
          21
        ],
        "status": "completed",
        "subtasks": []
      },
      {
        "id": 23,
        "title": "Regression test and polish",
        "description": "Run full tests and verify no security regression from engine expansion",
        "details": "Execute pytest suite; ensure approve gate, allowed paths, no file body output, and audit persistence remain unchanged. Validate /policy and /start text include current behavior.",
        "testStrategy": "Run ./.venv/bin/pytest -q and inspect failures; fix until green.",
        "priority": "high",
        "dependencies": [
          22
        ],
        "status": "completed",
        "subtasks": []
      },
      {
        "id": 24,
        "title": "Setup UX reorder and onboarding clarity patch",
        "description": "Reorder setup wizard prompts to ask Telegram bot token before mode/allowlist and document retest flow",
        "details": "Update scripts/setup_wizard.py prompt order for interactive mode: setup type -> instance_id -> telegram_bot_token -> engine mode -> allowlist user id. Add optional allowlist user_id auto-detection via Bot API getUpdates after the user sends /start. Keep codex_api_key prompt conditional after mode selection. Update .taskmaster/docs/prd.txt and docs/implementation_plan_10days.md with patch rationale and retest scope.",
        "testStrategy": "Run ./.venv/bin/python -m py_compile scripts/setup_wizard.py and ./.venv/bin/pytest -q. Manual dry-run with scripts/setup_macos.command on clean reset, verify prompt sequence and correct bot response after /start.",
        "priority": "high",
        "dependencies": [
          23
        ],
        "status": "completed",
        "subtasks": []
      }
    ],
    "metadata": {
      "created": "2026-02-25T05:38:46.024Z",
      "updated": "2026-02-26T10:39:44Z",
      "description": "Tasks for master context"
    }
  }
}
